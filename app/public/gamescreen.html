<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Gamescreen</title>
	<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <h1 id="gametitle"></h1>

    <p>Welcome to the game!</p>

    <p id="maptitle"></p>


</body>

<script src="https://pixijs.download/release/pixi.js"></script>

<script type="module">   

    let gametitle = document.getElementById("gametitle");
    let gamedata;
    let unittypes;
    let terraintypes;
    let gameunits;
    let querystring = window.location.href.slice(32);
    let selectedUnit;
    let selectedUnitMovableTiles;
    let mapterrain = new Array();
    const app = new PIXI.Application();
    await app.init({ width: 640, height: 360 })
    document.body.appendChild(app.canvas);

    await PIXI.Assets.load('neutralfactory.png');
    await PIXI.Assets.load('neutralHQ.png');
    await PIXI.Assets.load('redfactory.png');
    await PIXI.Assets.load('redHQ.png');
    await PIXI.Assets.load('bluefactory.png');
    await PIXI.Assets.load('blueHQ.png');
    await PIXI.Assets.load('field.png');
    await PIXI.Assets.load('redinfantry.png');
    await PIXI.Assets.load('blueinfantry.png');

    fetch("/terraintypes", {
        method: "GET"
    }).then(response => {
        console.log("terrain types fetched");
        return response.json();
    }).then(body => {
        terraintypes = body.rows;
        console.log(terraintypes);
    })

    fetch("/unittypes", {
        method: "GET"
    }).then(response => {
        console.log("unit types fetched");
        return response.json();
    }).then(body => {
        unittypes = body.rows;
    });

    fetch("/gameunits" + querystring, {
        method: "GET"
    }).then(response => {
        console.log("game units fetched");
        return response.json();
    }).then(body => {
        gameunits = body.rows;
    })

    fetch("/map" + querystring, {
        method: "GET"
    }).then(response => {
        console.log("map fetched");
        return response.json();
    }).then(body => {
        console.log(terraintypes);
        if (body.rows.length <= 0){
            console.log("No game found")
        } else {
            let mapdata = body.rows[0]
            maptitle.textContent = mapdata.title;
            for (let i = 0; i < mapdata.terrain.length; i++){
                let row = mapdata.terrain[i];
                let ownerRow = mapdata.cellowner[i];
                console.log(row);
                let y = i * 16;
                for (let j = 0; j < row.length; j++){
                    let x = j * 16;
                    if (row[j] == 1){
                        if (ownerRow[j] == 0){
                            let neutralHQ = PIXI.Sprite.from('neutralHQ.png');
                            terrainBuilder(neutralHQ, x, y, terraintypes[0]);
                        } else if (ownerRow[j] == 1){
                            let redHQ = PIXI.Sprite.from('redHQ.png');
                            terrainBuilder(redHQ, x, y, terraintypes[0]);
                        } else {
                            let blueHQ = PIXI.Sprite.from('blueHQ.png');
                            terrainBuilder(blueHQ, x, y, terraintypes[0]);
                        }
                    } else if (row[j] == 2){
                        if (ownerRow[j] == 0){
                            let neutralfactory = PIXI.Sprite.from('neutralfactory.png');
                            terrainBuilder(neutralfactory, x, y, terraintypes[1]);
                        } else if (ownerRow[j] == 1){
                            let redfactory = PIXI.Sprite.from('redfactory.png');
                            terrainBuilder(redfactory, x, y, terraintypes[1]);
                        } else {
                            let bluefactory = PIXI.Sprite.from('bluefactory.png');
                            terrainBuilder(bluefactory, x, y, terraintypes[1]);
                        }
                    }
                    else {
                        let field = PIXI.Sprite.from('field.png');
                        terrainBuilder(field, x, y, terraintypes[2]);
                    }
                }
            }
            let redinfantry = PIXI.Sprite.from('redinfantry.png');         
            redinfantry.on('click', onClickTerrain(redinfantry, unittypes[0], null));
            redinfantry.eventMode = 'dynamic';
            app.stage.addChild(redinfantry);
        }
    })

    fetch("/game" + querystring, {
        method: "GET"
    }).then(response => {
        console.log("game fetched");
        return response.json();
    }).then(body => {
    if (body.rows.length <= 0){
            console.log("No game found")
        } else {
            gametitle.textContent=body.rows[0].title;
            gamedata = body.rows[0];
            console.log(body.rows[0]);
        }

    });

    function onClickTerrain(terrain){
        if (selectedUnit != null && selectedUnit != undefined){
            selectedUnit.sprite.x = terrain.x;
            selectedUnit.sprite.y = terrain.y; 
        }
    }

    function terrainBuilder(sprite, x, y, type){
        sprite.y = y;
        sprite.x = x;
        sprite.on('click', (event) => onClickTerrain(sprite));
        sprite.eventMode = 'dynamic';
        mapterrain.push({'sprite': sprite, 'type': type})
        app.stage.addChild(sprite);
    }

    function onClickUnit(sprite, type, stats){
        selectedUnit = {'sprite': sprite, 'type': type, 'stats': stats};
        selectedUnitMovableTiles = new Array();
        let closedTiles = new Array();
        for (let i = 0; i < mapterrain.length; i++){
            curTile = mapterrain[i];
            
        }
    }
</script>

<script>
    
    
  </script>
</html>
